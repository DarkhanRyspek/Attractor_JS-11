-- CREATED ON 19.06.2018 BY U10097 
--CLOSE_MISC - 抢市垡扰 WA 倚劳抢手热
DEC-LARE 
  CNT NUMBER:=0;
  RES VARCHAR2(255);
  PSSLOG VARCHAR2(255);
  DID    NUMBER;
BEGIN
    
    FOR CUR IN (
               
SELECT AR.DOC__ID AS DOC_ID,
       AR.POSTING_DATE AS TR_DATE,
       OWS.XWAUTH_RECORD('CREDIT_STATUS',AR.CREDIT_STATUS)||' - '||
       OWS.XWAUTH_RECORD('POSTING_STATUS',AR.POSTING_STATUS)||' / '||AR.DOC__ID||' # '||AR.TRANS_TYPE||' - '||AR.TARGET_NUMBER AS INFO
  FROM OWS.AUTH_RECORD AR 
 WHERE AR.CREDIT_STATUS='A'
       AND AR.SERVICE_CLASS='M' AND AR.TRANS_TYPE NOT IN (35298,37204)
       AND AR.ACNT_CONTRACT__OID IN(SELECT T.IBANID  FROM (SELECT a.id AS IBANID,  a.contract_number AS IBAN,
               OWS.XWACNT_CONTRACT('CONTR_STATUS',A.CONTR_STATUS) AS CONTR_STATUS, A.CONTR_STATUS AS CONTR_STATUS2,
               a.curr as CUR, trunc(nvl(OWS.glob.LDATEACNT(a.id), OWS.glob.GET_DB_DATE_WS)) CurrDate,
               to_date(OWS.glob.get_TAG_VALUE(a.ext_data, 'ACTIVITY_DATE'),'yyyy-mm-dd') AS CNT_DATE,
               A.DATE_OPEN AS DATE_OPEN,A.DATE_EXPIRE AS DATE_EXPIRE,
               a.total_blocked AS BLOCK,
               a.total_balance AS BALCNCE,
               A.AMOUNT_AVAILABLE AS AMOUNT_AVAILABLE,
               A.IS_READY,a.comment_text as comment_text,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = a.id AND acc.code in ('P','P5','P4')), 0)) ClDeposit,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = A.id AND acc.code = 'D'), 0)) Dispute,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = A.id AND UPPER(acc.Account_Name) LIKE '%OVL%'), 0)) OVL,
                    
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = A.id AND acc.code NOT IN  ('P','P5','P4','91','D')
                    AND UPPER(acc.Account_Name) NOT LIKE '%OVL%'
                    AND ACC.CURRENT_BALANCE > 0 ), 0)) BAL_P,

               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = A.id AND acc.code NOT IN  ('P','P5','P4','91','D')
                    AND UPPER(acc.Account_Name) NOT LIKE '%OVL%'
                    AND ACC.CURRENT_BALANCE < 0 ), 0)) BAL_M,
                    
               nvl((SELECT SUM(AR.BASE_AMOUNT) FROM OWS.AUTH_RECORD AR
               WHERE AR.CREDIT_STATUS='A' AND AR.SERVICE_CLASS='M'  AND AR.ACNT_CONTRACT__OID=A.ID
               AND AR.TARGET_NUMBER=A.CONTRACT_NUMBER),0) AS IBAN_BLOCK,
               nvl((SELECT SUM(AR.BASE_AMOUNT) FROM OWS.AUTH_RECORD AR
                WHERE AR.CREDIT_STATUS='A' AND AR.SERVICE_CLASS='M'  AND AR.ACNT_CONTRACT__OID=A.ID
                AND AR.TARGET_NUMBER<>A.CONTRACT_NUMBER),0) AS CARD_BLOCK
          FROM OWS.acnt_contract a
         WHERE a.amnd_state = 'A' AND a.pcat = 'C'
               AND a.ccat = 'P' AND a.con_cat = 'A' AND A.CURR = '398'
               AND A.DATE_OPEN <= TO_DATE('22052018','DDMMYYYY')
               AND A.CONTR_STATUS NOT IN (1125,465,857,713,774)
               AND A.CONTRACT_NUMBER IN (SELECT S.ADD_DATA1 FROM SBERBANK_CUST.TEMP_WT S WHERE S.INFORM = 'ACC_CLOSED_KZT')
               AND (SELECT COUNT(*) FROM OWS.ACNT_CONTRACT C
                    WHERE C.AMND_STATE='A' AND C.ACNT_CONTRACT__OID=A.ID
                    AND C.CONTR_STATUS NOT IN (1077,176,109))=0
               AND EXISTS (SELECT 1 FROM OWS.acc_scheme acs
                           WHERE acs.id = a.acc_scheme__id AND acs.amnd_state = 'A'
                             AND acs.pcat = a.pcat AND acs.scheme_name LIKE 'Db%'))T
 WHERE T.ClDeposit+T.Dispute+T.OVL+T.BAL_P+T.BAL_M+T.IBAN_BLOCK+T.CARD_BLOCK <> 0
       AND T.CONTR_STATUS2 IN (86,1072)
       AND T.Dispute+T.OVL = 0   
       AND T.IBAN_BLOCK+T.CARD_BLOCK <> 0)
    
      )

  LOOP SELECT DOC.ID INTO DID FROM OWS.DOC DOC WHERE DOC.ID=CUR.DOC_ID AND DOC.AMND_STATE='A';
       
       IF DID IS NOT NULL THEN RES:=OWS.chck.CLOSE_MISC(CUR.DOC_ID);
       ELSE RES:='NULL DOC';
       END IF;
  
       DBMS_OUTPUT.put_line(RES||' INFO= '|| CUR.DOC_ID||' - '||CUR.TR_DATE||' for card '||CUR.INFO);      
       
       CNT:= CNT+1;
       IF CNT = 100
          THEN COMMIT;  
               CNT:=0; 
       END IF;
  END LOOP;
  COMMIT;
END;
