-- CREATED ON 19.06.2018 BY U10097 
--CLOSE_MISC - 抢市垡扰 WA 倚劳抢手热
DECLARE 
  CNT NUMBER:=0;
  RES VARCHAR2(255);
  PSSLOG VARCHAR2(255);
  DID    NUMBER;
BEGIN
    
    FOR CUR IN (

SELECT AR.DOC__ID AS DOC_ID,
       AR.POSTING_DATE AS TR_DATE,
       OWS.XWAUTH_RECORD('CREDIT_STATUS',AR.CREDIT_STATUS)||' - '||
       OWS.XWAUTH_RECORD('POSTING_STATUS',AR.POSTING_STATUS)||' / '||AR.DOC__ID||' # '||AR.TRANS_TYPE||' - '||AR.TARGET_NUMBER AS INFO,
       OWS.XWAUTH_RECORD('POSTING_STATUS',AR.POSTING_STATUS),AR.POSTING_STATUS
  FROM OWS.AUTH_RECORD AR 
 WHERE AR.CREDIT_STATUS='A'
       AND AR.SERVICE_CLASS='M' 
       AND ROWNUM <= 50000
       AND AR.ACNT_CONTRACT__OID IN (SELECT T.IBANID  FROM (SELECT A.ID AS IBANID,A.CONTRACT_NUMBER AS IBAN,A.IS_READY,
               A.AMOUNT_AVAILABLE,A.TOTAL_BLOCKED,A.TOTAL_BALANCE,
               TO_DATE(OWS.RPR.GET_TAG_VALUE(A.EXT_DATA,'ACTIVITY_DATE'),'YYYY-MM-DD') AS ACTIVITY_DATE,
               OWS.XWACNT_CONTRACT('CONTR_STATUS',A.CONTR_STATUS) AS CONTR_STATUS,A.CONTR_STATUS AS CONTR_STATUS2, A.CURR as CURR,
               A.DATE_OPEN AS DATE_OPEN,A.DATE_EXPIRE AS DATE_EXPIRE,
               OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'RPRO_FULL')|| OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'RPRO_PARTLY')||
               OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'ARREST_PARTLY')|| OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'ARREST_FULL')||
               OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'ARREST_IR')|| OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'ARREST_PTP') AS ALL_CL,
               nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
               WHERE acc.acnt_contract__oid = a.id AND acc.code in ('P')), 0) ClDepositP,
               nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
               WHERE acc.acnt_contract__oid = a.id AND acc.code in ('P4')),0) ClDepositP4,
               nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
               WHERE acc.acnt_contract__oid = a.id AND acc.code in ('P5')),0) ClDepositP5,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
               WHERE acc.acnt_contract__oid = A.id AND acc.code = 'D'), 0)) Dispute,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
               WHERE acc.acnt_contract__oid = A.id AND UPPER(acc.Account_Name) LIKE '%OVL%'), 0)) OVL,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
               WHERE acc.acnt_contract__oid = A.id AND acc.code IN ('AR','RPRO','TR','P6','P7','P3')), 0)) AS ARPI,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
               WHERE acc.acnt_contract__oid = A.id AND acc.code NOT IN  ('P','P4','P5','91','D','AR','RPRO','TR','P6','P7','P3','s')
               AND UPPER(acc.Account_Name) NOT LIKE '%OVL%' AND ACC.CURRENT_BALANCE > 0 ), 0)) BAL_P,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
               WHERE acc.acnt_contract__oid = A.id AND acc.code NOT IN  ('P','P4','P5','91','D','AR','RPRO','TR','P6','P7','P3','s')
               AND UPPER(acc.Account_Name) NOT LIKE '%OVL%' AND ACC.CURRENT_BALANCE < 0 ), 0)) BAL_M,
               nvl((SELECT SUM(AR.BASE_AMOUNT) FROM OWS.AUTH_RECORD AR
               WHERE AR.CREDIT_STATUS='A' AND AR.SERVICE_CLASS='M'  AND AR.ACNT_CONTRACT__OID=A.ID
               AND AR.TARGET_NUMBER=A.CONTRACT_NUMBER),0) AS IBAN_BLOCK,
               nvl((SELECT SUM(AR.BASE_AMOUNT) FROM OWS.AUTH_RECORD AR
               WHERE AR.CREDIT_STATUS='A' AND AR.SERVICE_CLASS='M'  AND AR.ACNT_CONTRACT__OID=A.ID
               AND AR.TARGET_NUMBER<>A.CONTRACT_NUMBER),0) AS CARD_BLOCK
          FROM OWS.acnt_contract a
         WHERE a.amnd_state = 'A' AND a.pcat = 'C' AND a.con_cat = 'A' AND a.ccat = 'P' 
               AND A.CONTRACT_NUMBER IN (SELECT A.CONTRACT_NUMBER FROM SBERBANK_CUST.TEMP_WT S, OWS.ACNT_CONTRACT A WHERE S.INFORM = 'IBANCL' 
                                        AND A.AMND_STATE='A' AND A.CONTRACT_NUMBER=S.ADD_DATA4 GROUP BY A.CONTRACT_NUMBER)
               AND A.CONTR_STATUS NOT IN (857,774,465,713,1167,1072) /*857-Account Blocked (KFM) 774-Account PTP 465-Account Blocked*/
               AND EXISTS (SELECT 1 FROM OWS.acc_scheme acs WHERE acs.id = a.acc_scheme__id AND acs.amnd_state = 'A'
                            AND acs.pcat = a.pcat AND acs.scheme_name LIKE 'Db%'))T
  WHERE T.Dispute+T.OVL = 0 
        AND T.ALL_CL not LIKE '%Y%'
        AND T.IBAN_BLOCK+T.CARD_BLOCK <> 0)
      )

  LOOP SELECT DOC.ID INTO DID FROM OWS.DOC DOC WHERE DOC.ID=CUR.DOC_ID AND DOC.AMND_STATE='A';
       
       IF DID IS NOT NULL THEN RES:=OWS.chck.CLOSE_MISC(CUR.DOC_ID);
       ELSE RES:='NULL DOC';
       END IF;
  
       --DBMS_OUTPUT.put_line(RES||' INFO= '|| CUR.DOC_ID||' - '||CUR.TR_DATE);      
       
       CNT:= CNT+1;
       IF CNT = 100
          THEN COMMIT;  
               CNT:=0; 
       END IF;
  END LOOP;
  COMMIT;
END;
