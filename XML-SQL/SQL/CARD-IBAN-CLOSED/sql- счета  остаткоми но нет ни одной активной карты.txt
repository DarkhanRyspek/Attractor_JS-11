SELECT T.IBANID,T.IBAN,T.CONTR_STATUS,T.CUR,T.CNT_DATE,T.IS_READY,
       T.DATE_OPEN,T.DATE_EXPIRE,T.BLOCK,T.BALCNCE,
       T.ClDeposit,T.Dispute,T.OVL,T.BAL_P,T.BAL_M,T.IBAN_BLOCK,T.CARD_BLOCK
  FROM (SELECT a.id AS IBANID,  a.contract_number AS IBAN,
               OWS.XWACNT_CONTRACT('CONTR_STATUS',A.CONTR_STATUS) AS CONTR_STATUS,
               a.curr as CUR,
               trunc(nvl(OWS.glob.LDATEACNT(a.id), OWS.glob.GET_DB_DATE_WS)) CurrDate,
               to_date(OWS.glob.get_TAG_VALUE(a.ext_data, 'ACTIVITY_DATE'),'yyyy-mm-dd') AS CNT_DATE,
               A.DATE_OPEN AS DATE_OPEN,A.DATE_EXPIRE AS DATE_EXPIRE,
               a.total_blocked AS BLOCK,
               a.total_balance AS BALCNCE,
               A.IS_READY,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = a.id AND acc.code in ('P','P5','P4')), 0)) ClDeposit,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = A.id AND acc.code = 'D'), 0)) Dispute,
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = A.id AND UPPER(acc.Account_Name) LIKE '%OVL%'), 0)) OVL,
                    
               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = A.id AND acc.code NOT IN  ('P','P5','P4','91','D')
                    AND UPPER(acc.Account_Name) NOT LIKE '%OVL%'
                    AND ACC.CURRENT_BALANCE > 0 ), 0)) BAL_P,

               ABS(nvl((SELECT SUM(acc.current_balance) FROM OWS.account acc
                    WHERE acc.acnt_contract__oid = A.id AND acc.code NOT IN  ('P','P5','P4','91','D')
                    AND UPPER(acc.Account_Name) NOT LIKE '%OVL%'
                    AND ACC.CURRENT_BALANCE < 0 ), 0)) BAL_M,
                    
               nvl((SELECT SUM(AR.BASE_AMOUNT) FROM OWS.AUTH_RECORD AR
               WHERE AR.CREDIT_STATUS='A' AND AR.SERVICE_CLASS='M'  AND AR.ACNT_CONTRACT__OID=A.ID
               AND AR.TARGET_NUMBER=A.CONTRACT_NUMBER),0) AS IBAN_BLOCK,
               nvl((SELECT SUM(AR.BASE_AMOUNT) FROM OWS.AUTH_RECORD AR
                WHERE AR.CREDIT_STATUS='A' AND AR.SERVICE_CLASS='M'  AND AR.ACNT_CONTRACT__OID=A.ID
                AND AR.TARGET_NUMBER<>A.CONTRACT_NUMBER),0) AS CARD_BLOCK
          FROM OWS.acnt_contract a
         WHERE a.amnd_state = 'A' AND a.pcat = 'C'
               AND a.ccat = 'P' AND a.con_cat = 'A'
               AND A.CONTR_STATUS NOT IN (857,774,465)
               AND (SELECT COUNT(*) FROM OWS.ACNT_CONTRACT C
                    WHERE C.AMND_STATE='A' AND C.ACNT_CONTRACT__OID=A.ID
                    AND C.CONTR_STATUS NOT IN (1077,176,109))=0
               AND EXISTS (SELECT 1 FROM OWS.acc_scheme acsa
                           WHERE acs.id = a.acc_scheme__id AND acs.amnd_state = 'A'
                             AND acs.pcat = a.pcat AND acs.scheme_name LIKE 'Db%'))T
 WHERE T.ClDeposit+T.Dispute+T.OVL+T.BAL_P+T.BAL_M+T.IBAN_BLOCK+T.CARD_BLOCK <> 0 
 ORDER BY T.IBANID DESC
 -- 262880
 -- 135199
