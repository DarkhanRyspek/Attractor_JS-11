-- TRACE
-- CREATED ON 19.06.2018 BY U10097  CLOSE_MISC - 抢市垡扰 WA 倚劳抢手热
DECLARE 
  CNT NUMBER:=0;
  RES VARCHAR2(255);
  PSSLOG VARCHAR2(255);
  DID    NUMBER;
BEGIN
    FOR CUR IN (
        
SELECT AR.DOC__ID AS DOC_ID,
       AR.POSTING_DATE AS TR_DATE,
       OWS.XWAUTH_RECORD('CREDIT_STATUS',AR.CREDIT_STATUS)||' - '||
       OWS.XWAUTH_RECORD('POSTING_STATUS',AR.POSTING_STATUS)||' / '||AR.DOC__ID||' # '||AR.TRANS_TYPE||' - '||AR.TARGET_NUMBER AS INFO,
       OWS.XWAUTH_RECORD('POSTING_STATUS',AR.POSTING_STATUS),AR.POSTING_STATUS
  FROM OWS.AUTH_RECORD AR 
 WHERE AR.CREDIT_STATUS='A'
       AND AR.SERVICE_CLASS='M'
       AND AR.POSTING_STATUS <> 'D'
       --AND AR.TRANS_TYPE=41338
       AND ROWNUM <= 50000
       AND AR.ACNT_CONTRACT__OID IN (SELECT A.ID
                                     FROM SBERBANK_CUST.TEMP_WT S,OWS.ACNT_CONTRACT A
                                     WHERE S.INFORM = 'IBAN_CLS' AND S.ID1=A.ID AND A.AMND_STATE='A')    
                                                                 
      )

  LOOP 
     BEGIN
       SELECT DOC.ID INTO DID FROM OWS.DOC DOC WHERE DOC.ID=CUR.DOC_ID AND DOC.AMND_STATE='A';
       
       IF DID IS NOT NULL THEN RES:=OWS.chck.CLOSE_MISC(CUR.DOC_ID);
       ELSE RES:='NULL DOC';
       END IF;

       CNT:= CNT+1;
       IF CNT = 100
          THEN COMMIT;  
               CNT:=0; 
       END IF;

       exception when others 
         then 
           DBMS_OUTPUT.put_line('DOC_ID=' || CUR.DOC_ID || ' ' || sqlerrm);  
     END;     
  END LOOP;
  COMMIT;
  
END;
