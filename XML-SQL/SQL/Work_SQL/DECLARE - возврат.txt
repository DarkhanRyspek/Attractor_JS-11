-- CREATED ON 13.01.2020 BY U10097 
-- Возврат списанных комиссий
DECLARE
DOC_ID NUMBER;
BEGIN
  FOR REC IN (

SELECT T.AMOUNT1 AS AMOUNT,
       T.IBAN_ID, T.IBAN,T.CURR
FROM (SELECT S.ADD_DATA1,S.AMOUNT1,S.INFORM,
             A.ID AS IBAN_ID, A.CONTRACT_NUMBER AS IBAN,A.CURR, 
             A.IS_READY,
             OWS.XWACNT_CONTRACT('CONTR_STATUS',A.CONTR_STATUS) AS CONTR_STATUS2,A.CONTR_STATUS,
             A.DATE_EXPIRE,
             OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'RPRO_FULL')|| OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'RPRO_PARTLY')||
             OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'ARREST_PARTLY')|| OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'ARREST_FULL')||
             OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'ARREST_IR')|| OWS.DECR.GET_STATUS_CODE(A.ID,NULL,NULL,'ARREST_PTP') AS ALL_CL
      FROM SBERBANK_CUST.TEMP_WT S, OWS.ACNT_CONTRACT A
      WHERE S.INFORM = 'IBANZPV'
      AND S.ADD_DATA1=A.CONTRACT_NUMBER
      AND A.AMND_STATE='A'
      AND A.CONTR_STATUS NOT IN (1072,273,713,857,465,1125))T
 WHERE T.ALL_CL NOT LIKE '%YES%'
 AND T.IBAN_ID<>11979251


       )
  LOOP
  SELECT OWS.DOC_SEQ.NEXTVAL INTO DOC_ID FROM DUAL;
  
  INSERT INTO OWS.DOC(ACQ_REF_NUMBER, ACTION, AMND_DATE, AMND_OFFICER, AMND_STATE, AUTH_CODE, CARD_EXPIRE, CARD_SEQV_NUMBER, FX_SETTL_DATE, 
                    IS_AUTHORIZATION, ISS_REF_NUMBER, MERCHANT_ID, MESSAGE_CATEGORY, NUMBER_OF_SUB_S, NW_REF_DATE, DOC__ORIG__ID, OUTWARD_STATUS, 
                    POSTING_DATE, POSTING_STATUS, DOC__PREV__ID, AMND_PREV, PS_REF_NUMBER, REASON_CODE, REASON_DETAILS, REC_MEMBER_ID, RECONS_AMOUNT, RECONS_CURR,
                    ID, REQUEST_CATEGORY, REQUIREMENT, RET_REF_NUMBER, RETURN_CODE, SEC_TRANS_COND_ATT, SEC_TRANS_DATE, SENDING_BIN, SEND_MEMBER_ID, SERVICE_CLASS,
                    SETTL_AMOUNT, SETTL_CURR, SIC_CODE, SOURCE_ACC_TYPE, S_CAT, SOURCE_CHANNEL, SOURCE_CODE, SOURCE_CONTRACT, SOURCE_FEE_AMOUNT, SOURCE_FEE_CODE, 
                    SOURCE_FEE_CURR, SOURCE_MEMBER_ID, SOURCE_NUMBER, SOURCE_REG_NUM, SOURCE_SPC, DOC__SUMM__ID, 
                    TARGET_ACC_TYPE, TARGET_BIN_ID, T_CAT, TARGET_CHANNEL, TARGET_CODE, TARGET_CONTRACT, TARGET_FEE_AMOUNT, TARGET_FEE_CODE, TARGET_FEE_CURR, 
                    TARGET_MEMBER_ID, TARGET_NUMBER, TARGET_SPC, TRANS_AMOUNT, TRANS_CITY, TRANS_COND_ATTR, TRANS_CONDITION, TRANS_COUNTRY, TRANS_CURR, 
                    TRANS_DATE, TRANS_DETAILS, TRANS_STATE, PARTITION_KEY, TRANS_TYPE, SYNCH_TAG, SOURCE_IDT_SCHEME, SOURCE_SERVICE, TARGET_IDT_SCHEME, 
                    TARGET_SERVICE, BIN_RECORD, NUMBER_IN_CHAIN, ADD_INFO, CHANGE_VERSION)
VALUES(NULL,NULL,SYSDATE,46726,'A',NULL,NULL,NULL,NULL,
       'N',NULL,NULL,'U',1,NULL,NULL,'W',
       NULL,'W',NULL,DOC_ID,NULL,NULL,NULL,NULL,0,NULL,
       DOC_ID,'P',NULL,NULL,0,NULL,NULL,NULL,NULL,'A',
       REC.AMOUNT,REC.CURR,NULL,'p',NULL,NULL,NULL,357546,0,NULL,
       NULL,NULL,'038-INTERESTS',NULL,NULL,NULL,
       'P',NULL,NULL,NULL,NULL,REC.IBAN_ID,0,NULL,NULL,
       NULL,REC.IBAN,NULL,REC.AMOUNT,NULL,NULL,NULL,NULL,REC.CURR,
       SYSDATE,'Возврат списанных комиссий за ведение неактивного счета',NULL,'X',NULL,NULL,NULL,NULL,NULL,
       NULL,NULL,NULL,NULL,0);


DBMS_OUTPUT.put_line(REC.IBAN||' '||DOC_ID||' '||REC.IBAN_ID||' '||REC.AMOUNT||' '||'OK');
END LOOP;
COMMIT;
END;
