-- MgrScript_ActiveteFEE
-- Анонимная процедура для переподключения FEE
BEGIN
  FOR REC IN (
             SELECT A.ID AS card_id
  FROM SBERBANK_CUST.TEMP_WT W,OWS.ACNT_CONTRACT A
 WHERE W.INFORM = 'MIGR_VISAPLATSAL_050521_OLD' AND W.ADD_DATA2='MIGR0'
       AND A.AMND_STATE='A' AND A.ID=W.ID2 AND A.IS_READY='Y'
       AND OWS.XWACNT_CONTRACT('PARENT_PRODUCT',A.PARENT_PRODUCT) LIKE '%TPLAN%'
       /*SELECT a.id  card_id
             FROM OWS.ACNT_CONTRACT A
            WHERE A.AMND_STATE='A' 
                  AND A.ID IN (47147841,28090400,16483207)  */
             )
  LOOP    
  
  DECLARE
  USGOLD_ID number := null;
  USGOLD_DATES varchar2(20) := null;
  USGOLD_DATEE varchar2(20) := null;
  USGNEW_ID number := null;
  v_usage_action_id number := null;
  v_ErrMsg varchar2(400);
  v_sqlerrm varchar2(800);
  BEGIN
    /*НАБОР ДАННЫХ*/
    SELECT T.ID_U,T.ST_DATE,T.END_DATE
    INTO USGOLD_ID,USGOLD_DATES,USGOLD_DATEE    
    FROM( select U.ID AS ID_U,TO_CHAR(U.START_DATE,'YYYY-MM-DD') AS ST_DATE,sy_convert.GET_TAG_VALUE(u.event_details, 'ORIG_END_DATE') AS END_DATE
                from ows.usage_action u
               where u.acnt_contract__id = REC.CARD_ID
                     AND U.POSTING_STATUS IN ('C')
                     and u.event_type in (select t.id from ows.event_type t where t.amnd_state = 'A' 
                                          and t.name IN ('Activate Monthly Fee'))
          UNION ALL
          select U.ID AS ID_U,TO_CHAR(U.START_DATE,'YYYY-MM-DD') AS ST_DATE,TO_CHAR(U.END_DATE,'YYYY-MM-DD') AS END_DATE
                from ows.usage_action u
               where u.acnt_contract__id = REC.CARD_ID
                     AND U.POSTING_STATUS IN ('S')
                     and u.event_type in (select t.id from ows.event_type t where t.amnd_state = 'A' 
                                          and t.name IN ('Card Fee Monthly')))T;
    
     UPDATE OWS.USAGE_ACTION U1
        SET U1.POSTING_STATUS='C'
      WHERE U1.ID=USGOLD_ID;

     v_usage_action_id := EVNT.QUE_EVENT_D(10024, rec.card_id, null, null, null, TO_DATE(USGOLD_DATEE,'YYYY-MM-DD'), 'Переподключение Fee с корректной датой');
    
                                
   /* select U.ID
      INTO USGNEW_ID
      from ows.usage_action u
     where u.acnt_contract__id = REC.CARD_ID AND U.POSTING_STATUS='S'
           and u.event_type in (select t.id from ows.event_type t where t.amnd_state = 'A' and t.name IN ('Activate Monthly Fee -2YEARLY'));

    CLOSE Activate Monthly Fee -2YEARLY
    v_ErrMsg := evnt.REVERSE_EVENT_MAN(USGNEW_ID);*/
  
  /*DBMS_OUTPUT.put_line(REC.CARD_ID||' / '||USGOLD_ID||' / '||USGOLD_DATES||' / '||USGOLD_DATEE||' * '||USGNEW_ID||' - '||v_ErrMsg||' - '||v_usage_action_id);  */
  COMMIT;
      
    EXCEPTION
      WHEN OTHERS
        THEN 
          v_sqlerrm := sqlerrm;
          INSERT INTO OPT_TMP_TPLAN_MIGR_LOG
          (proc_date, acnt_contract_id, status, error_level, msg)
          values
          (sysdate, rec.card_id, 'CARD_FEE', 'INFO', SUBSTR(v_sqlerrm || ' > ' || dbms_utility.format_error_backtrace, 1, 380));
          COMMIT;
  END;
  END LOOP;           
  END;
