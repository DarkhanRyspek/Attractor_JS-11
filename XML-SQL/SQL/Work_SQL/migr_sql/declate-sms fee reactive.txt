-- MgrScript_ActiveteSMS-ActivateFee
-- Анонимная процедура для переподключения SMS
BEGIN
  FOR rec IN (
    
    SELECT A.ID AS card_id
  FROM SBERBANK_CUST.TEMP_WT W,OWS.ACNT_CONTRACT A
 WHERE W.INFORM = 'MIGR_VISAPLATSAL_050521_OLD' AND W.ADD_DATA2='MIGR0'
       AND A.AMND_STATE='A' AND A.ID=W.ID2 AND A.IS_READY='Y'
       AND OWS.XWACNT_CONTRACT('PARENT_PRODUCT',A.PARENT_PRODUCT) LIKE '%TPLAN%'
   
      /* SELECT a.id  card_id
             FROM OWS.ACNT_CONTRACT A
            WHERE A.AMND_STATE='A' 
                  AND A.ID IN (47147841,28090400,16483207)     */
             )
  LOOP
  
    DECLARE
      add_sms1_by_migr number := null;
      mb_loy_period_by_migr number := null;
      mb_loy_period_prev_migr number := null;
      v_usage_action_id number := null;
      V_ORIG_END_DATE varchar2(20) := null;
      v_ErrMsg varchar2(400);
      v_sqlerrm varchar2(800);
    BEGIN

      select u.id 
      into add_sms1_by_migr
        from ows.usage_action u
       where u.acnt_contract__id = rec.card_id
         and u.event_type in (select t.id from ows.event_type t where t.amnd_state = 'A' and t.name = 'ADD_SMS1')
         and u.start_date=(select g.local_date from ows.global_constants g where g.amnd_state='A')
         and u.event_details like '%Переподключение SMS после изменения продукта%' and u.posting_status='S';  

      select u.id 
      into mb_loy_period_by_migr
        from ows.usage_action u
       where u.usage_action__oid = add_sms1_by_migr
         and u.POSTING_STATUS='S'
         and u.event_type in (select t.id from ows.event_type t where t.amnd_state = 'A' and t.name = 'MB_LOY_PERIOD 3');
 
      --Был ли льготный период по SMS на момент миграции
      begin
        select u.id 
        into mb_loy_period_prev_migr
          from ows.usage_action u
         where u.acnt_contract__id = rec.card_id 
           and u.id<>mb_loy_period_by_migr
           and u.event_type in (select t.id from ows.event_type t where t.amnd_state = 'A' and t.name = 'MB_LOY_PERIOD 3')
           and u.end_date=(select g.local_date from ows.global_constants g where g.amnd_state='A');
            -------Добавить в условие статус MB_LOY_PERIOD
      exception
        when no_data_found
          then null;
      end;     

      IF mb_loy_period_prev_migr is not null 
        THEN 
          --с mb_loy_period_prev_migr вытащить ORIG_END_DATE
          select sy_convert.GET_TAG_VALUE(u.event_details, 'ORIG_END_DATE') ORIG_END_DATE
          INTO  V_ORIG_END_DATE
          from ows.usage_action u 
          where u.id=mb_loy_period_prev_migr;
          
          --запустить MB_MONTHLY_FEE датой ORIG_END_DATE
          v_usage_action_id := EVNT.QUE_EVENT_D(85, rec.card_id, null, null, null, to_date(V_ORIG_END_DATE, 'yyyy-mm-dd'), 'Переподключение SMS с корректной датой');
          
          --закрыть mb_loy_period_by_migr
          v_ErrMsg := evnt.REVERSE_EVENT_MAN(mb_loy_period_by_migr);
      ELSIF mb_loy_period_prev_migr is null 
        THEN 
          --выбрать последний MB_MONTHLY_FEE, вытащить ORIG_END_DATE. MB_MONTHLY_FEE с End_date - дата миграции
          select sy_convert.GET_TAG_VALUE(u.event_details, 'ORIG_END_DATE') ORIG_END_DATE 
          into V_ORIG_END_DATE
          from ows.usage_action u
          where u.acnt_contract__id = rec.card_id 
          and u.event_type in (select t.id from ows.event_type t where t.amnd_state = 'A' and t.name = 'MB_MONTHLY_FEE')
          and u.end_date=(select g.local_date from ows.global_constants g where g.amnd_state='A')
          and u.POSTING_STATUS='C';

          --запустить MB_MONTHLY_FEE датой ORIG_END_DATE
          v_usage_action_id := EVNT.QUE_EVENT_D(85, rec.card_id, null, null, null, to_date(V_ORIG_END_DATE, 'yyyy-mm-dd'), 'Переподключение SMS с корректной датой');
          
          --закрыть mb_loy_period_by_migr
          v_ErrMsg := evnt.REVERSE_EVENT_MAN(mb_loy_period_by_migr);
      END IF;
    
      COMMIT;
      
    EXCEPTION
      WHEN OTHERS
        THEN 
          v_sqlerrm := sqlerrm;
          INSERT INTO OPT_TMP_TPLAN_MIGR_LOG
          (proc_date, acnt_contract_id, status, error_level, msg)
          values
          (sysdate, rec.card_id, 'MB_FEE', 'INFO', SUBSTR(v_sqlerrm || ' > ' || dbms_utility.format_error_backtrace, 1, 380));
          COMMIT;
        
    END;  
      
  END LOOP;
END;



